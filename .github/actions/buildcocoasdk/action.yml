name: Build Native Dependencies
description: Builds Sentry Cocoa SDK with custom Carthage
runs:
  using: composite

  steps:

    - name: Fetch version tags for Sentry Cocoa SDK
      shell: bash
      run: git fetch --tags --quiet
      working-directory: modules/sentry-cocoa

    - name: Get Sentry Cocoa SHA
      shell: bash
      run: echo "SENTRY_COCOA_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
      working-directory: modules/sentry-cocoa

    - name: Cache Sentry Cocoa SDK
      id: cache-sentry-cocoa
      uses: actions/cache@v3
      with:
        path: modules/sentry-cocoa/Carthage
        key: sentry-cocoa-${{ env.SENTRY_COCOA_SHA }}

    - name: Build Sentry Cocoa SDK
      if: ${{ steps.cache-sentry-cocoa.outputs.cache-hit != 'true' }}
      shell: bash
      run: scripts/build-sentry-cocoa.sh

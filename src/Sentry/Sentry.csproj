<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <Description>Official SDK for Sentry - Open-source error tracking that helps developers monitor and fix crashes in real time.</Description>
    <NoWarn Condition="'$(TargetFramework)' == 'netstandard2.0'">$(NoWarn);RS0017</NoWarn>
  </PropertyGroup>

  <PropertyGroup Condition="'$(SolutionName)' != 'Sentry.Unity'">
    <TargetFrameworks>net6.0;net5.0;netcoreapp3.0;netstandard2.1;netstandard2.0;net461</TargetFrameworks>
    <TargetFrameworks Condition="'$(NO_ANDROID)' == ''">$(TargetFrameworks);net6.0-android</TargetFrameworks>
    <TargetFrameworks Condition="'$(NO_IOS)' == '' And $([MSBuild]::IsOSPlatform('OSX'))">$(TargetFrameworks);net6.0-ios</TargetFrameworks>
    <TargetFrameworks Condition="'$(NO_MACCATALYST)' == '' And $([MSBuild]::IsOSPlatform('OSX'))">$(TargetFrameworks);net6.0-maccatalyst</TargetFrameworks>
  </PropertyGroup>

  <PropertyGroup Condition="'$(SolutionName)' == 'Sentry.Unity'">
    <TargetFramework>netstandard2.0</TargetFramework>
  </PropertyGroup>

  <!-- Platform-specific props included here -->
  <Import Project="Platforms\Android\Sentry.Android.props" Condition="'$(TargetPlatformIdentifier)' == 'android'" />
  <Import Project="Platforms\iOS\Sentry.iOS.props" Condition="'$(TargetPlatformIdentifier)' == 'ios' Or '$(TargetPlatformIdentifier)' == 'maccatalyst'" />

  <!--
    Ben.Demystifier is compiled directly into Sentry.
    Note: It uses Microsoft.Bcl.AsyncInterfaces, which we get transitively from System.Text.Json.
  -->
  <ItemGroup>
    <Compile Include="..\..\modules\Ben.Demystifier\src\**\*.cs">
      <Link>%(RecursiveDir)\%(Filename)%(Extension)</Link>
    </Compile>
  </ItemGroup>
  <ItemGroup Condition="$(TargetFramework.StartsWith('netstandard')) or $(TargetFramework.StartsWith('net4'))">
    <PackageReference Include="System.Reflection.Metadata" Version="5.0.0" />
  </ItemGroup>

  <!-- Sentry.DiagnosticSource is compiled directly into Sentry for .NET Core and .NET targets only. -->
  <PropertyGroup Condition="!$(TargetFramework.StartsWith('netstandard')) and !$(TargetFramework.StartsWith('net4'))">
    <DefineConstants>$(DefineConstants);HAS_DIAGNOSTIC_INTEGRATION</DefineConstants>
  </PropertyGroup>
  <ItemGroup Condition="!$(TargetFramework.StartsWith('netstandard')) and !$(TargetFramework.StartsWith('net4'))">
    <Compile Include="..\Sentry.DiagnosticSource\Internal\**\*.cs">
      <Link>Internal\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </Compile>
  </ItemGroup>

  <!--
    We use Simon Cropp's Polyfill source-only package to access APIs in lower targets.
    https://github.com/SimonCropp/Polyfill
  -->
  <ItemGroup>
    <PackageReference Include="Polyfill" Version="1.9.1" PrivateAssets="all" />
  </ItemGroup>

  <!--
    On .NET Framework, we need a package reference to System.Runtime.InteropServices.RuntimeInformation.
    This is used in Sentry.PlatformAbstractions.RuntimeInfo.  It's already built-in for all other targets.
  -->
  <ItemGroup Condition="$(TargetFramework.StartsWith('net4'))">
    <PackageReference Include="System.Runtime.InteropServices.RuntimeInformation" Version="4.3.0" />
  </ItemGroup>

  <!-- On .NET Framework, we need an assembly reference to System.Net.Http. -->
  <ItemGroup Condition="$(TargetFramework.StartsWith('net4'))">
    <Reference Include="System.Net.Http" />
  </ItemGroup>

  <!-- System.Text.Json is already included with .NET 5 and higher. Add a direct reference for other targets. -->
  <ItemGroup Condition="!$(TargetFramework.StartsWith('net5')) and !$(TargetFramework.StartsWith('net6'))">
    <PackageReference Include="System.Text.Json" Version="5.0.2" />
  </ItemGroup>

  <!--
    Include Sentry's custom targets file in the nuget package.
    This file contains targets that are invoked during the end-user's build.
    The same file is included twice, so it ends up being used for both direct and transitive package references to Sentry.
  -->
  <ItemGroup>
    <None Include="buildTransitive\Sentry.targets" Pack="true" PackagePath="buildTransitive\Sentry.targets" />
    <None Include="buildTransitive\Sentry.targets" Pack="true" PackagePath="build\Sentry.targets" />
  </ItemGroup>

  <!-- Download the Sentry CLI during the restore phase. -->
  <Target Name="DownloadSentryCLI" BeforeTargets="CollectPackageReferences" Condition="'$(SentryCLIDirectory)' != ''">

    <!--
      Hashes are from https://release-registry.services.sentry.io/apps/sentry-cli/latest
      Update with each new version.
    -->
    <PropertyGroup>
      <_OSArchitecture>$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture)</_OSArchitecture>
    </PropertyGroup>
    <ItemGroup>
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('OSX')) And $(_OSArchitecture) == 'Arm64')"
        Include="sentry-cli-Darwin-arm64" FileHash="a9a190cea6e1d0aee6295cdae4626ffd299534ef4974e3fca6b72dbc04ea450a" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('OSX')) And $(_OSArchitecture) == 'X64')"
        Include="sentry-cli-Darwin-x86_64" FileHash="f94fc13fa653a4a80ae9c1d3695967a53a745c4d6867fb73437c06454621ecc3" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('Linux')) And $(_OSArchitecture) == 'Arm64')"
        Include="sentry-cli-Linux-aarch64" FileHash="484f0c59c85663c49a0b190fc4dd439ee8b0fc5a9a353e0681ace392d6875744" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('Linux')) And $(_OSArchitecture) == 'X86')"
        Include="sentry-cli-Linux-i686" FileHash="e0064c765f446a8f17c49c93ba8615a70ddb3fa077633a3c1b29c42286697065" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('Linux')) And $(_OSArchitecture) == 'X64')"
        Include="sentry-cli-Linux-x86_64" FileHash="7f6a7f1abbd3f3012ec24373b323ec8e9c400057a45edddc47941be8bc5729ac" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('Windows')) And $(_OSArchitecture) == 'X86')"
        Include="sentry-cli-Windows-i686.exe" FileHash="2bb148267b1f42604f9226d9b2958fe32a2665e22809cbe745f2194a1269ccea" />
      <SentryCLIDownload
        Condition="'$(CI_PUBLISHING_BUILD)' == 'true' Or ($([MSBuild]::IsOSPlatform('Windows')) And $(_OSArchitecture) != 'X86')"
        Include="sentry-cli-Windows-x86_64.exe" FileHash="8aa178120470f85a8ab5f39edfa0c23292dfaec62e770425100669c62de40072" />
    </ItemGroup>

    <!-- Download the files -->
    <DownloadFile
      SourceUrl="https://downloads.sentry-cdn.com/sentry-cli/$(SentryCLIVersion)/%(SentryCLIDownload.Identity)"
      DestinationFolder="$(SentryCLIDirectory)"
      Condition="!Exists('$(SentryCLIDirectory)%(Identity)')"
      Retries="3">
      <Output TaskParameter="DownloadedFile" ItemName="SentryCLIDownloadedFile" />
    </DownloadFile>

    <!-- Build will fail if any downloaded files don't match the expected hash. -->
    <VerifyFileHash File="$(SentryCLIDirectory)%(SentryCLIDownload.Identity)" Hash="%(FileHash)" />

    <!-- Set executable permissions for local usage. -->
    <Exec Command="chmod +x $(SentryCLIDirectory)*" Condition="!$([MSBuild]::IsOSPlatform('Windows'))" />
  </Target>

  <!-- Bundle the Sentry CLI into the Sentry Nuget package. -->
  <ItemGroup Condition="'$(SentryCLIDirectory)' != ''">
    <None Include="$(SentryCLIDirectory)**" Pack="true" PackagePath="tools\" />
  </ItemGroup>

</Project>

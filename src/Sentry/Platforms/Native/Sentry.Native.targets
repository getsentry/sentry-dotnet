<Project>

  <PropertyGroup>
    <SentryNativeSourceDirectory>..\..\modules\sentry-native\</SentryNativeSourceDirectory>
    <SentryNativeLibraryName>sentry-native</SentryNativeLibraryName>
    <SentryNativeBuildScript>../../scripts/build-sentry-native.ps1</SentryNativeBuildScript>
    <SentryNativeBuildInputs>../../.git/modules/modules/sentry-native/HEAD;$(MSBuildThisFileDirectory)Sentry.Native.targets;$(SentryNativeBuildScript)</SentryNativeBuildInputs>
    <SentryNativeOutputDirectory>$(MSBuildThisFileDirectory)runtimes\</SentryNativeOutputDirectory>
    <!-- List of runtime identifiers: https://github.com/dotnet/runtime/blob/main/src/libraries/Microsoft.NETCore.Platforms/src/runtime.json -->
    <NativeLibRelativePath-win-x64>win-x64\native</NativeLibRelativePath-win-x64>
    <SentryNativeOutputDirectory-win-x64>$(SentryNativeOutputDirectory)$(NativeLibRelativePath-win-x64)\</SentryNativeOutputDirectory-win-x64>
    <NativeLibRelativePath-linux-x64>linux-x64\native</NativeLibRelativePath-linux-x64>
    <SentryNativeOutputDirectory-linux-x64>$(SentryNativeOutputDirectory)$(NativeLibRelativePath-linux-x64)\</SentryNativeOutputDirectory-linux-x64>
    <NativeLibRelativePath-osx>osx\native</NativeLibRelativePath-osx>
    <SentryNativeOutputDirectory-osx>$(SentryNativeOutputDirectory)$(NativeLibRelativePath-osx)\</SentryNativeOutputDirectory-osx>
  </PropertyGroup>

  <!-- Packaging -->
  <ItemGroup>
    <!-- Include our transitive build targets in the nuget. -->
    <None Include="$(MSBuildThisFileDirectory)buildTransitive.targets">
      <Pack>true</Pack>
      <PackagePath>buildTransitive\Sentry.Native.targets</PackagePath>
    </None>
  </ItemGroup>

  <!-- Packaging the native library -->
  <ItemGroup Condition="'$(CI_PUBLISHING_BUILD)' == 'true' or $([MSBuild]::IsOsPlatform('Windows'))">
    <None Include="$(SentryNativeOutputDirectory-win-x64)$(SentryNativeLibraryName).lib">
      <Pack>true</Pack>
      <PackagePath>\runtimes\$(NativeLibRelativePath-win-x64)</PackagePath>
    </None>
  </ItemGroup>

  <ItemGroup Condition="'$(CI_PUBLISHING_BUILD)' == 'true' or $([MSBuild]::IsOsPlatform('Linux'))">
    <None Include="$(SentryNativeOutputDirectory-linux-x64)lib$(SentryNativeLibraryName).a">
      <Pack>true</Pack>
      <PackagePath>\runtimes\$(NativeLibRelativePath-linux-x64)</PackagePath>
    </None>
  </ItemGroup>

  <ItemGroup Condition="'$(CI_PUBLISHING_BUILD)' == 'true' or $([MSBuild]::IsOsPlatform('OSX'))">
    <None Include="$(SentryNativeOutputDirectory-osx)lib$(SentryNativeLibraryName).a">
      <Pack>true</Pack>
      <PackagePath>\runtimes\$(NativeLibRelativePath-osx)</PackagePath>
    </None>
  </ItemGroup>

  <Target Name="CleanNativeSDK" BeforeTargets="CoreClean">
    <Message Text="Inside Custom Clean" Importance="high"/>
    <RemoveDir Directories="$(SentryNativeOutputDirectory)" />
    <RemoveDir Directories="$(SentryNativeSourceDirectory)build" />
  </Target>

  <!-- Build the Sentry Native SDK -->
  <Target Name="_InnerBuildSentryNativeSDK">
    <Exec Command="pwsh $(SentryNativeBuildScript)" />
  </Target>

  <Target Name="_BuildSentryNativeSDK-win-x64"
    BeforeTargets="DispatchToInnerBuilds;BeforeBuild"
    Condition="'$(CI)' != 'true' and $([MSBuild]::IsOsPlatform('Windows'))"
    Inputs="$(SentryNativeBuildInputs)"
    Outputs="$(SentryNativeOutputDirectory-win-x64)$(SentryNativeLibraryName).lib">
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_InnerBuildSentryNativeSDK" Properties="TargetFramework=net6.0" />
  </Target>

  <Target Name="_BuildSentryNativeSDK-linux-x64"
    BeforeTargets="DispatchToInnerBuilds;BeforeBuild"
    Condition="'$(CI)' != 'true' and $([MSBuild]::IsOsPlatform('Linux'))"
    Inputs="$(SentryNativeBuildInputs)"
    Outputs="$(SentryNativeOutputDirectory-linux-x64)lib$(SentryNativeLibraryName).a">
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_InnerBuildSentryNativeSDK" Properties="TargetFramework=net6.0" />
  </Target>

  <Target Name="_BuildSentryNativeSDK-osx"
    BeforeTargets="DispatchToInnerBuilds;BeforeBuild"
    Condition="'$(CI)' != 'true' and $([MSBuild]::IsOsPlatform('OSX'))"
    Inputs="$(SentryNativeBuildInputs)"
    Outputs="$(SentryNativeOutputDirectory-osx)lib$(SentryNativeLibraryName).a">
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_InnerBuildSentryNativeSDK" Properties="TargetFramework=net6.0" />
  </Target>
</Project>

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>net8.0;net6.0;netstandard2.0</TargetFrameworks>
    <PackageTags>$(PackageTags);AspNetCore;MVC</PackageTags>
    <Description>Official ASP.NET Core integration for Sentry - Open-source error tracking that helps developers monitor and fix crashes in real time.</Description>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Sentry.Extensions.Logging\Sentry.Extensions.Logging.csproj" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.0'">
    <ProjectReference Include="..\Sentry.DiagnosticSource\Sentry.DiagnosticSource.csproj" />

    <PackageReference Include="Microsoft.AspNetCore.Hosting" Version="2.1.0" />
    <PackageReference Include="Microsoft.AspNetCore.Diagnostics.Abstractions" Version="2.1.0" />
    <PackageReference Include="Microsoft.AspNetCore.Routing.Abstractions" Version="2.1.0" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="2.1.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="2.1.0" />
    <PackageReference Include="System.Diagnostics.DiagnosticSource" Version="4.5.0" />

    <!-- this is needed because the version that is brought in transitively has a vulnerability warning -->
    <PackageReference Include="Microsoft.AspNetCore.Http" Version="2.1.22" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFramework)' != 'netstandard2.0'">
    <FrameworkReference Include="Microsoft.AspNetCore.App" />
  </ItemGroup>

  <!-- Sentry Browser Replay Worker -->
  <PropertyGroup>
    <!-- TODO: Needs an auto update solution -->
    <SentryBrowserVersion>7.80.1</SentryBrowserVersion>
    <SentryBrowserWorkerExpectedFileHash>D292CE4ECC0927646B2AED7A2762FC93056187846BE641D982301A973CB74F09</SentryBrowserWorkerExpectedFileHash>
    <SentryJavaScriptIntermediatePath>$(MSBuildThisFileDirectory)obj/sentry-browser-$(SentryBrowserVersion)/</SentryJavaScriptIntermediatePath>
    <SentryJavaScriptWorkerFileName>worker.min.js</SentryJavaScriptWorkerFileName>
    <SentryJavaScriptWorkerIntermediateFilePath>$(SentryJavaScriptIntermediatePath)$(SentryJavaScriptWorkerFileName)</SentryJavaScriptWorkerIntermediateFilePath>
    <SentryJavaScriptWorkerFinalFileName>worker-$(SentryBrowserWorkerExpectedFileHash.ToLower().Substring(0, 7)).js</SentryJavaScriptWorkerFinalFileName>
    <SentryJavaScriptWorkerFinalFilePath>$(SentryJavaScriptIntermediatePath)$(SentryJavaScriptWorkerFinalFileName)</SentryJavaScriptWorkerFinalFilePath>
    <!-- set to false below if local file is up to date -->
    <DownloadSentryJavaScriptWorker>true</DownloadSentryJavaScriptWorker>
  </PropertyGroup>
  <ItemGroup>
    <Item Include="$(SentryJavaScriptWorkerFinalFilePath)"
          Link="JavaScript/$(SentryJavaScriptWorkerFinalFileName)"
          Pack="true" PackagePath="tools\" />
  </ItemGroup>
  <Target Name="CheckSentryJavaScriptWorkerNeedsDownloading" BeforeTargets="Build" 
          Condition="Exists($(SentryJavaScriptWorkerFinalFilePath))">
    <GetFileHash Files="$(SentryJavaScriptWorkerFinalFilePath)">
      <Output TaskParameter="Items" ItemName="SentryJavaScriptWorkerActualFileHash" />
    </GetFileHash>
    <PropertyGroup>
      <DownloadSentryJavaScriptWorker 
        Condition="'$(SentryBrowserWorkerExpectedFileHash)' == '' 
        or $(SentryJavaScriptWorkerActualFileHash) != '@(SentryJavaScriptWorkerActualFileHash->'%(FileHash)')'">false</DownloadSentryJavaScriptWorker>
    </PropertyGroup>
  </Target>
  <!-- Download the Sentry Session Replay worker JavaScript file to bundle in the package and serve via middlewre. -->
  <Target Name="DownloadReplayWorker" AfterTargets="CheckSentryJavaScriptWorkerNeedsDownloading" Condition="$(DownloadSentryJavaScriptWorker) == true">
    <!-- TODO: Worker isn't published to npm or the cdn yet -->
    <DownloadFile SourceUrl="https://raw.githubusercontent.com/getsentry/sentry-javascript/$(SentryBrowserVersion)/packages/replay-worker/examples/$(SentryJavaScriptWorkerFileName)"
                  Retries="3"
                  DestinationFolder="$(SentryJavaScriptIntermediatePath)">
    </DownloadFile>
    <!-- Break the build if hash doesn't match -->
    <VerifyFileHash File="$(SentryJavaScriptWorkerIntermediateFilePath)" Hash="$(SentryBrowserWorkerExpectedFileHash)" />
    <Move SourceFiles="$(SentryJavaScriptWorkerIntermediateFilePath)"
          DestinationFiles="$(SentryJavaScriptWorkerFinalFilePath)" />
  </Target>
  <!-- Sentry Browser Replay Worker -->

  <ItemGroup>
    <InternalsVisibleTo Include="Sentry.AspNetCore.Tests" PublicKey="$(SentryPublicKey)" />
    <InternalsVisibleTo Include="Sentry.AspNetCore.Grpc" PublicKey="$(SentryPublicKey)" />
    <InternalsVisibleTo Include="Sentry.Google.Cloud.Functions" PublicKey="$(SentryPublicKey)" />
    <InternalsVisibleTo Include="Sentry.Google.Cloud.Functions.Tests" PublicKey="$(SentryPublicKey)" />
  </ItemGroup>

</Project>

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>net9.0;net8.0</TargetFrameworks>
    <!-- IMPORTANT: We must test with new TFMs as the store format changes with new versions of .NET -->
    <TargetFrameworks Condition="'$(NO_ANDROID)' == ''">$(TargetFrameworks);net8.0-android34.0;net9.0-android35.0</TargetFrameworks>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\src\Sentry.Android.AssemblyReader\Sentry.Android.AssemblyReader.csproj" />
    <ProjectReference Include="..\Sentry.Testing\Sentry.Testing.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="TestAPKs\" />
  </ItemGroup>

  <!--  Build the Android test app in various configurations during the build of this test project. -->
  <Target Name="BuildTestAPKs" BeforeTargets="DispatchToInnerBuilds;BeforeBuild" Condition="'$(TargetPlatformIdentifier)' != 'android'">
    <MSBuild Projects="..\AndroidTestApp\AndroidTestApp.csproj" Targets="Restore" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_InnerBuildTestAPKs" Properties="TargetFramework=net8.0-android" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_InnerBuildTestAPKs" Properties="TargetFramework=net9.0-android" />
  </Target>
  <Target Name="_InnerBuildTestAPKs">
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Properties="_Aot=false;_Store=False;_Compressed=False" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Properties="_Aot=false;_Store=False;_Compressed=True" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Properties="_Aot=false;_Store=True;_Compressed=False" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Properties="_Aot=false;_Store=True;_Compressed=True" />

    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Condition="!$(TargetFramework.StartsWith('net8'))" Properties="_Aot=true;_Store=False;_Compressed=False" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Condition="!$(TargetFramework.StartsWith('net8'))" Properties="_Aot=true;_Store=False;_Compressed=True" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Condition="!$(TargetFramework.StartsWith('net8'))" Properties="_Aot=true;_Store=True;_Compressed=False" />
    <MSBuild Projects="$(MSBuildProjectFile)" Targets="_BuildTestAPK" Condition="!$(TargetFramework.StartsWith('net8'))" Properties="_Aot=true;_Store=True;_Compressed=True" />
  </Target>
  <Target Name="_BuildTestAPK">
    <PropertyGroup>
      <_ConfigString>A=$(_Aot)-S=$(_Store)-C=$(_Compressed)</_ConfigString>
    </PropertyGroup>
    <Message Text="Building APK for $(TargetFramework) with config: $(_ConfigString)" Importance="high" />
    <MSBuild Projects="..\AndroidTestApp\AndroidTestApp.csproj" Targets="Build" Properties="Configuration=Release;PublishAot=$(_Aot);_IsPublishing=true;AndroidUseAssemblyStore=$(_Store);AndroidEnableAssemblyCompression=$(_Compressed);OutDir=bin\$(TargetFramework)\$(_ConfigString)\" Condition="!Exists('TestAPKs\$(TargetFramework)-$(_ConfigString).apk')" />

    <PropertyGroup>
      <SourceAPKExists Condition="Exists('..\AndroidTestApp\bin\$(TargetFramework)\$(_ConfigString)\com.companyname.AndroidTestApp-Signed.apk')">True</SourceAPKExists>
      <SourceAPKExists Condition="!Exists('..\AndroidTestApp\bin\$(TargetFramework)\$(_ConfigString)\com.companyname.AndroidTestApp-Signed.apk')">False</SourceAPKExists>
      <DestinationAPKExists Condition="Exists('TestAPKs\$(TargetFramework)-$(_ConfigString).apk')">True</DestinationAPKExists>
      <DestinationAPKExists Condition="!Exists('TestAPKs\$(TargetFramework)-$(_ConfigString).apk')">False</DestinationAPKExists>
    </PropertyGroup>
    <Message Text="Copying APK from ..\AndroidTestApp\bin\$(TargetFramework)\$(_ConfigString)\com.companyname.AndroidTestApp-Signed.apk to TestAPKs\$(TargetFramework)-$(_ConfigString).apk" Importance="high" />
    <Message Text="Source APK exists: $(SourceAPKExists)" Importance="high" />
    <Copy SourceFiles="..\AndroidTestApp\bin\$(TargetFramework)\$(_ConfigString)\com.companyname.AndroidTestApp-Signed.apk" DestinationFiles="TestAPKs\$(TargetFramework)-$(_ConfigString).apk" Condition="!Exists('TestAPKs\$(TargetFramework)-$(_ConfigString).apk')" />
    <Message Text="APK copy result: Exists('TestAPKs\$(TargetFramework)-$(_ConfigString).apk') = $(DestinationAPKExists)" Importance="high" />
  </Target>

</Project>
